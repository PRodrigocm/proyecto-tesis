@startuml
!theme plain
title Sistema de Gestión de Asistencias y Retiros - Diagrama de Estados

package "Estados de Retiro" {
  state "Inicial" as RetiroInicial
  state "Solicitado" as RetiroSolicitado
  state "En Revisión" as RetiroEnRevision
  state "Aprobado" as RetiroAprobado
  state "Rechazado" as RetiroRechazado
  state "En Proceso" as RetiroEnProceso
  state "Completado" as RetiroCompletado
  state "Cancelado" as RetiroCancelado

  [*] --> RetiroInicial
  RetiroInicial --> RetiroSolicitado : Apoderado solicita retiro
  RetiroSolicitado --> RetiroEnRevision : Auxiliar revisa solicitud
  RetiroSolicitado --> RetiroAprobado : Apoderado titular aprueba
  RetiroSolicitado --> RetiroRechazado : Apoderado titular rechaza
  RetiroEnRevision --> RetiroAprobado : Auxiliar aprueba
  RetiroEnRevision --> RetiroRechazado : Auxiliar rechaza
  RetiroAprobado --> RetiroEnProceso : Auxiliar inicia retiro
  RetiroEnProceso --> RetiroCompletado : Estudiante retirado exitosamente
  RetiroEnProceso --> RetiroCancelado : Retiro cancelado por circunstancias
  RetiroSolicitado --> RetiroCancelado : Apoderado cancela solicitud
  RetiroAprobado --> RetiroCancelado : Retiro cancelado antes de ejecutar
  
  RetiroCompletado --> [*]
  RetiroRechazado --> [*]
  RetiroCancelado --> [*]
}

package "Estados de Justificación" {
  state "Nueva" as JustifNueva
  state "Pendiente" as JustifPendiente
  state "En Revisión" as JustifEnRevision
  state "Aprobada" as JustifAprobada
  state "Rechazada" as JustifRechazada
  state "Aplicada" as JustifAplicada
  state "Vencida" as JustifVencida

  [*] --> JustifNueva
  JustifNueva --> JustifPendiente : Apoderado presenta justificación
  JustifPendiente --> JustifEnRevision : Docente/Auxiliar revisa
  JustifPendiente --> JustifVencida : Tiempo límite excedido
  JustifEnRevision --> JustifAprobada : Justificación aceptada
  JustifEnRevision --> JustifRechazada : Justificación rechazada
  JustifAprobada --> JustifAplicada : Se aplica a asistencias
  
  JustifAplicada --> [*]
  JustifRechazada --> [*]
  JustifVencida --> [*]
}

package "Estados de Asistencia" {
  state "Sin Registrar" as AsistSinRegistrar
  state "Presente" as AsistPresente
  state "Tardanza" as AsistTardanza
  state "Inasistencia" as AsistInasistencia
  state "Justificada" as AsistJustificada
  state "Excusada" as AsistExcusada

  [*] --> AsistSinRegistrar
  AsistSinRegistrar --> AsistPresente : Estudiante llega a tiempo
  AsistSinRegistrar --> AsistTardanza : Estudiante llega tarde (dentro tolerancia)
  AsistSinRegistrar --> AsistInasistencia : No se registra entrada
  AsistPresente --> AsistJustificada : Se aplica justificación posterior
  AsistTardanza --> AsistJustificada : Se aplica justificación posterior
  AsistInasistencia --> AsistJustificada : Se aplica justificación
  AsistInasistencia --> AsistExcusada : Justificación administrativa
  
  AsistPresente --> [*]
  AsistTardanza --> [*]
  AsistJustificada --> [*]
  AsistExcusada --> [*]
}

package "Estados de Usuario" {
  state "Inactivo" as UserInactivo
  state "Activo" as UserActivo
  state "Suspendido" as UserSuspendido
  state "Bloqueado" as UserBloqueado
  state "Eliminado" as UserEliminado

  [*] --> UserInactivo
  UserInactivo --> UserActivo : Activación de cuenta
  UserActivo --> UserSuspendido : Suspensión temporal
  UserActivo --> UserBloqueado : Bloqueo por seguridad
  UserActivo --> UserEliminado : Eliminación de cuenta
  UserSuspendido --> UserActivo : Fin de suspensión
  UserSuspendido --> UserEliminado : Eliminación durante suspensión
  UserBloqueado --> UserActivo : Desbloqueo administrativo
  UserBloqueado --> UserEliminado : Eliminación por seguridad
  
  UserEliminado --> [*]
}

package "Estados de Sesión" {
  state "No Autenticado" as SesionNoAuth
  state "Autenticando" as SesionAuth
  state "Autenticado" as SesionAutenticado
  state "Expirado" as SesionExpirado
  state "Cerrado" as SesionCerrado

  [*] --> SesionNoAuth
  SesionNoAuth --> SesionAuth : Usuario inicia login
  SesionAuth --> SesionAutenticado : Credenciales válidas
  SesionAuth --> SesionNoAuth : Credenciales inválidas
  SesionAutenticado --> SesionExpirado : Token expira
  SesionAutenticado --> SesionCerrado : Usuario cierra sesión
  SesionExpirado --> SesionNoAuth : Renovación de sesión
  SesionCerrado --> SesionNoAuth : Nueva sesión
  
  SesionNoAuth --> [*]
}

package "Estados de Código QR" {
  state "Generado" as QRGenerado
  state "Activo" as QRActivo
  state "Usado" as QRUsado
  state "Expirado" as QRExpirado
  state "Inválido" as QRInvalido
  state "Renovado" as QRRenovado

  [*] --> QRGenerado
  QRGenerado --> QRActivo : Activar código
  QRActivo --> QRUsado : Escanear para asistencia
  QRActivo --> QRExpirado : Tiempo de validez vencido
  QRActivo --> QRRenovado : Renovar código
  QRUsado --> QRActivo : Reutilizable para próxima asistencia
  QRExpirado --> QRRenovado : Generar nuevo código
  QRInvalido --> QRRenovado : Corregir y regenerar
  QRRenovado --> QRActivo : Código renovado exitosamente
  
  QRExpirado --> [*]
  QRInvalido --> [*]
}

note top of RetiroSolicitado : "Estado inicial cuando\nun apoderado solicita\nun retiro"

note right of JustifAprobada : "Justificación aprobada\npero aún no aplicada\na las asistencias"

note bottom of AsistInasistencia : "Estado que requiere\njustificación del\napoderado"

note left of UserActivo : "Usuario con acceso\ncompleto al sistema"

note top of QRActivo : "Código QR válido\nlisto para ser\nescaneado"

@enduml
