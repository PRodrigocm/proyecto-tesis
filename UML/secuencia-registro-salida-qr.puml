@startuml
!theme plain
title Secuencia: Registro de Salida con Código QR

participant "Estudiante" as E
participant "Auxiliar" as AUX
participant "Escáner QR\n(Dispositivo)" as QR
participant "Frontend\n(Next.js)" as F
participant "API Routes" as API
participant "Auth Middleware" as Auth
participant "Business Logic" as BL
participant "Prisma ORM" as P
participant "PostgreSQL" as DB
participant "Notification\nService" as NS
participant "Email/SMS\nProvider" as ESP

== Proceso de Registro de Salida ==

E -> AUX: Presenta código QR para salida
AUX -> QR: Escanea código QR del estudiante
QR -> F: Envía código QR escaneado
F -> API: POST /api/asistencias/registrar-salida
API -> Auth: Verificar token JWT del auxiliar
Auth -> API: Token válido, rol AUXILIAR
API -> BL: Procesar código QR para salida

== Validación y Búsqueda de Registro ==

BL -> BL: Validar formato del código QR

alt Código QR válido
    BL -> P: Buscar registro de entrada del día
    P -> DB: SELECT asistencia WHERE estudiante_id = ? AND fecha = TODAY()
    
    alt Registro de entrada encontrado
        DB -> P: Registro de entrada encontrado
        P -> BL: Registro de entrada válido
        
        alt Aún no registró salida
            BL -> P: Actualizar registro con hora de salida
            P -> DB: UPDATE asistencias SET hora_salida = NOW() WHERE id = ?
            DB -> P: Registro actualizado
            P -> BL: Salida registrada exitosamente
            
            == Proceso de Notificación ==
            
            BL -> NS: Verificar notificaciones de salida
            NS -> P: Obtener config de notificaciones (salida_ie)
            P -> DB: SELECT notif_config WHERE estudiante_id = ?
            
            alt Notificaciones de salida habilitadas
                DB -> P: Notificaciones de salida habilitadas
                P -> NS: Configuración obtenida
                NS -> P: Obtener apoderados del estudiante
                P -> DB: SELECT apoderados FROM estudiante_apoderado WHERE estudiante_id = ?
                DB -> P: Lista de apoderados
                P -> NS: Datos de apoderados
                NS -> ESP: Enviar notificación de salida
                note right: "Su hijo [Nombre] salió de la IE a las [Hora]"
                ESP -> NS: Notificación enviada
                NS -> BL: Proceso completado
            else Notificaciones deshabilitadas
                DB -> P: Notificaciones deshabilitadas
                P -> NS: No enviar notificaciones
                NS -> BL: Proceso omitido
            end
            
            BL -> API: Registro de salida exitoso
            API -> F: Response 200 con confirmación
            F -> AUX: Muestra confirmación de salida
            AUX -> E: Confirma salida registrada
            
        else Ya registró salida
            P -> BL: Ya existe hora de salida
            BL -> API: Error - Ya registró salida hoy
            API -> F: Response 400 con error
            F -> AUX: Muestra error "Ya registró salida"
            AUX -> E: Informa que ya registró salida
        end
        
    else No hay registro de entrada
        DB -> P: No hay registro de entrada
        P -> BL: No puede registrar salida sin entrada
        BL -> API: Error - No hay registro de entrada
        API -> F: Response 400 con error
        F -> AUX: Muestra error "No registró entrada"
        AUX -> E: Informa que debe registrar entrada primero
    end
    
else Código QR inválido
    BL -> API: Error - Formato de código inválido
    API -> F: Response 400 con error
    F -> AUX: Muestra error "Código QR inválido"
    AUX -> E: Solicita código QR correcto
end

@enduml
